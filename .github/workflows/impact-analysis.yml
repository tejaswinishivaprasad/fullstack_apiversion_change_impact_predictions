name: PR impact analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  issues: write
  pull-requests: write

jobs:
  run-impact-analysis:
    name: Run AI Core analysis (PR)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PYTHON_VERSION: "3.11"
      AI_CORE_DIR: "impact_ai_repo/ai-core/src"
      CI_SCRIPT: ".github/scripts/ci_analyze_pr.sh"

    steps:
      - name: Checkout code (full history needed for diffs)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure base branch is fetched (helps some checkout setups)
        if: ${{ github.event.pull_request.base.ref != '' }}
        run: |
          echo "Fetching base branch: ${{ github.event.pull_request.base.ref }}"
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true

      - name: Set up Python (stable runtime)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip (based on light requirements file if present)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/impact_ai_repo/ai-core/src/requirements-ci.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install minimal CI deps (requirements-ci.txt if present)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f impact_ai_repo/ai-core/src/requirements-ci.txt ]; then
            echo "Using requirements-ci.txt (fast deps for PR runs)"
            python -m pip install --prefer-binary -r impact_ai_repo/ai-core/src/requirements-ci.txt
          else
            echo "No requirements-ci.txt found. Skipping heavy installs for PR run."
          fi

      - name: Debug git state (helpful when files_changed == 0)
        run: |
          echo "=== git branch/ref ==="
          git rev-parse --abbrev-ref HEAD || true
          git show --no-patch --pretty=format:'HEAD: %H' HEAD || true
          echo "=== recent commits ==="
          git --no-pager log --oneline -n 10 || true
          echo "=== remote heads (top) ==="
          git ls-remote --heads origin | sed -n '1,20p' || true
          echo "=== try diff origin/main...HEAD ==="
          git fetch origin main --depth=1 || true
          git diff --name-only origin/main...HEAD || true
          echo "=== list curated canonical folder (if present) ==="
          ls -la impact_ai_repo/ai-core/src/datasets/curated/canonical || true

      - name: Make CI script executable
        run: chmod +x .github/scripts/ci_analyze_pr.sh || true

      - name: Run CI analysis script
        id: run_analysis
        env:
          AI_CORE_DIR: ${{ env.AI_CORE_DIR }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -x
          .github/scripts/ci_analyze_pr.sh
        continue-on-error: true

      - name: Upload report artifact (if produced)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-impact-report-${{ github.event.pull_request.number }}
          path: pr-impact-report.json

      - name: Read short summary for comment
        id: summary
        if: always()
        run: |
          OUT="./pr-impact-report.json"
          if [ ! -f "$OUT" ]; then
            echo "summary=No report produced" >> $GITHUB_OUTPUT
            exit 0
          fi
          RISK=$(jq -r '.impact_assessment.score // .predicted_risk // .risk_score // .predictedRisk // .risk_summary // "n/a"' "$OUT" 2>/dev/null || echo "n/a")
          FILES=$(jq -r '.files_changed | length // 0' "$OUT" 2>/dev/null || echo 0)
          API=$(jq -r '.api_endpoint_changes // .api_changes // (.atomic_change_events | length) // 0' "$OUT" 2>/dev/null || echo 0)
          echo "summary=Risk: ${RISK} | Files: ${FILES} | API changes: ${API}" >> $GITHUB_OUTPUT

      - name: Update or create single PR comment (replace previous bot comment)
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- pr-impact-bot -->
            ### PR Impact Analysis â€” Summary
            ${{ steps.summary.outputs.summary }}

            Artifact: pr-impact-report-${{ github.event.pull_request.number }}
          edit-mode: replace
